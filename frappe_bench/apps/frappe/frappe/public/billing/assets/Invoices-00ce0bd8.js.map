{"version":3,"file":"Invoices-00ce0bd8.js","sources":["../../../../billing/src/pages/Invoices.vue"],"sourcesContent":["<template>\n\t<header class=\"flex h-10.5 border-b items-center justify-between py-2 px-5 shrink-0\">\n\t\t<Breadcrumbs :items=\"[{ label: 'Invoices' }]\" />\n\t</header>\n\t<div class=\"flex flex-col overflow-hidden px-60 pt-6\">\n\t\t<ListView\n\t\t\t:columns=\"columns\"\n\t\t\t:rows=\"rows\"\n\t\t\trow-key=\"id\"\n\t\t\t:options=\"{\n\t\t\t\tselectable: false,\n\t\t\t}\"\n\t\t>\n\t\t\t<ListHeader />\n\t\t\t<ListRows>\n\t\t\t\t<ListRow v-for=\"row in rows\" :key=\"row.id\" v-slot=\"{ column, item }\" :row=\"row\">\n\t\t\t\t\t<ListRowItem :item=\"item\" :align=\"column.align\">\n\t\t\t\t\t\t<template #prefix>\n\t\t\t\t\t\t\t<InvoiceIcon v-if=\"column.key == 'name'\" class=\"h-4\" />\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\tv-if=\"column.key == 'status'\"\n\t\t\t\t\t\t\t:label=\"item.label\"\n\t\t\t\t\t\t\tvariant=\"subtle\"\n\t\t\t\t\t\t\t:theme=\"item.color\"\n\t\t\t\t\t\t\tsize=\"md\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tv-if=\"\n\t\t\t\t\t\t\t\tcolumn.key == 'button' &&\n\t\t\t\t\t\t\t\titem.status == 'Unpaid' &&\n\t\t\t\t\t\t\t\titem.amount_due > 0\n\t\t\t\t\t\t\t\"\n\t\t\t\t\t\t\tlabel=\"Pay now\"\n\t\t\t\t\t\t\t@click.stop=\"item.payNow\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<template #prefix>\n\t\t\t\t\t\t\t\t<FeatherIcon name=\"external-link\" class=\"h-4 w-4\" />\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tv-else-if=\"column.key == 'button' && item.url\"\n\t\t\t\t\t\t\tlabel=\"Download\"\n\t\t\t\t\t\t\t@click.stop=\"item.download\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<template #prefix>\n\t\t\t\t\t\t\t\t<FeatherIcon name=\"download\" class=\"h-4 w-4\" />\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</ListRowItem>\n\t\t\t\t</ListRow>\n\t\t\t</ListRows>\n\t\t</ListView>\n\t</div>\n</template>\n<script setup>\nimport InvoiceIcon from '@/icons/InvoiceIcon.vue'\nimport {\n\tListView,\n\tListHeader,\n\tListRows,\n\tListRow,\n\tListRowItem,\n\tFeatherIcon,\n\tButton,\n\tBadge,\n\tcreateResource,\n\tBreadcrumbs,\n} from 'frappe-ui'\nimport { computed, inject } from 'vue'\n\nconst team = inject('team')\n\nconst invoices = createResource({\n\turl: 'frappe.integrations.frappe_providers.frappecloud_billing.api',\n\tparams: { method: 'billing.get_invoices' },\n\tcache: 'invoices',\n\tauto: true,\n})\n\nconst columns = [\n\t{\n\t\tlabel: 'Invoice',\n\t\tkey: 'name',\n\t\twidth: 1.2,\n\t},\n\t{\n\t\tlabel: 'Status',\n\t\tkey: 'status',\n\t\twidth: 0.8,\n\t},\n\t{\n\t\tlabel: 'Period',\n\t\tkey: 'due_date',\n\t\twidth: 1.5,\n\t},\n\t{\n\t\tlabel: 'Total',\n\t\tkey: 'total',\n\t\twidth: 1,\n\t},\n\t{\n\t\tlabel: '',\n\t\tkey: 'button',\n\t\twidth: 1,\n\t\talign: 'right',\n\t},\n]\n\nconst rows = computed(() => {\n\tif (!team.data) return []\n\treturn invoices.data?.map((invoice) => {\n\t\t// Set name based on invoice type\n\t\tlet name = 'Prepaid Credits'\n\t\tif (invoice.type == 'Subscription') {\n\t\t\tname = new Date(invoice.period_end).toLocaleString('en-US', {\n\t\t\t\tmonth: 'long',\n\t\t\t\tyear: 'numeric',\n\t\t\t})\n\t\t}\n\n\t\t// Set due date based on invoice type\n\t\tlet due_date = new Date(invoice.due_date).toLocaleString('en-US', {\n\t\t\tyear: 'numeric',\n\t\t\tmonth: 'short',\n\t\t\tday: 'numeric',\n\t\t})\n\t\tif (invoice.type == 'Subscription') {\n\t\t\tlet start = new Date(invoice.period_start)\n\t\t\tlet end = new Date(invoice.period_end)\n\t\t\tlet sameYear = start.getFullYear() === end.getFullYear()\n\t\t\tlet formattedStart = sameYear\n\t\t\t\t? start.toLocaleString('en-US', { month: 'short', day: 'numeric' })\n\t\t\t\t: start.toLocaleString('en-US', { dateStyle: 'short' })\n\t\t\tlet formattedEnd = end.toLocaleString('en-US', {\n\t\t\t\tyear: 'numeric',\n\t\t\t\tmonth: 'short',\n\t\t\t\tday: 'numeric',\n\t\t\t})\n\t\t\tdue_date = `${formattedStart} - ${formattedEnd}`\n\t\t}\n\n\t\treturn {\n\t\t\tid: invoice.name,\n\t\t\tname: name,\n\t\t\tstatus: {\n\t\t\t\tlabel: invoice.status,\n\t\t\t\tcolor:\n\t\t\t\t\tinvoice.status === 'Paid'\n\t\t\t\t\t\t? 'green'\n\t\t\t\t\t\t: invoice.status == 'Unpaid'\n\t\t\t\t\t\t? 'orange'\n\t\t\t\t\t\t: 'gray',\n\t\t\t},\n\t\t\tdue_date: due_date,\n\t\t\ttotal: formatCurrency(invoice.total),\n\t\t\tbutton: {\n\t\t\t\turl: invoice.invoice_pdf,\n\t\t\t\tdownload: () => downloadInvoice(invoice.name),\n\t\t\t\tstatus: invoice.status,\n\t\t\t\tamount_due: invoice.amount_due,\n\t\t\t\tpayNow: () => payNow(invoice),\n\t\t\t},\n\t\t}\n\t})\n})\n\nfunction payNow(invoice) {\n\tif (invoice.stripe_invoice_url) {\n\t\twindow.open(invoice.stripe_invoice_url, '_blank')\n\t} else {\n\t\tcreateResource({\n\t\t\turl: 'frappe.integrations.frappe_providers.frappecloud_billing.api',\n\t\t\tparams: {\n\t\t\t\tmethod: 'billing.get_stripe_payment_url_for_invoice',\n\t\t\t\tdata: { name: invoice.name },\n\t\t\t},\n\t\t\tauto: true,\n\t\t\tonSuccess: (url) => window.open(url, '_blank'),\n\t\t})\n\t}\n}\n\nfunction downloadInvoice(invoice) {\n\tcreateResource({\n\t\turl: 'frappe.integrations.frappe_providers.frappecloud_billing.get_token_and_base_url',\n\t\tauto: true,\n\t\tonSuccess: (data) => {\n\t\t\tfetch(`${data.base_url}/api/method/press.saas.api.billing.download_invoice`, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t\t'X-Site-Access-Token': data.token,\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({ name: invoice }),\n\t\t\t})\n\t\t\t\t.then((response) => {\n\t\t\t\t\tif (!response.ok) {\n\t\t\t\t\t\tthrow new Error('Network response was not ok ' + response.statusText)\n\t\t\t\t\t}\n\t\t\t\t\treturn response.blob()\n\t\t\t\t})\n\t\t\t\t.then((blob) => {\n\t\t\t\t\tconst url = window.URL.createObjectURL(blob)\n\t\t\t\t\twindow.open(url, '_blank')\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tconsole.error('There was a problem with the fetch operation:', error)\n\t\t\t\t})\n\t\t},\n\t})\n}\n\nfunction formatCurrency(value) {\n\tif (value === 0) {\n\t\treturn ''\n\t}\n\treturn userCurrency(value)\n}\n\nfunction currency(value, currency, fractions = 2) {\n\treturn new Intl.NumberFormat('en-US', {\n\t\tstyle: 'currency',\n\t\tcurrency,\n\t\tmaximumFractionDigits: fractions,\n\t}).format(value)\n}\n\nfunction userCurrency(value, fractions = 2) {\n\treturn currency(value, team.data?.currency, fractions)\n}\n</script>\n"],"names":["team","inject","invoices","createResource","columns","rows","computed","_a","invoice","name","due_date","start","end","formattedStart","formattedEnd","formatCurrency","downloadInvoice","payNow","url","data","response","blob","error","value","userCurrency","currency","fractions"],"mappings":"geAuEA,MAAMA,EAAOC,EAAO,MAAM,EAEpBC,EAAWC,EAAe,CAC/B,IAAK,+DACL,OAAQ,CAAE,OAAQ,sBAAwB,EAC1C,MAAO,WACP,KAAM,EACP,CAAC,EAEKC,EAAU,CACf,CACC,MAAO,UACP,IAAK,OACL,MAAO,GACP,EACD,CACC,MAAO,SACP,IAAK,SACL,MAAO,EACP,EACD,CACC,MAAO,SACP,IAAK,WACL,MAAO,GACP,EACD,CACC,MAAO,QACP,IAAK,QACL,MAAO,CACP,EACD,CACC,MAAO,GACP,IAAK,SACL,MAAO,EACP,MAAO,OACP,CACF,EAEMC,EAAOC,EAAS,IAAM,OAC3B,OAAKN,EAAK,MACHO,EAAAL,EAAS,OAAT,YAAAK,EAAe,IAAKC,GAAY,CAEtC,IAAIC,EAAO,kBACPD,EAAQ,MAAQ,iBACnBC,EAAO,IAAI,KAAKD,EAAQ,UAAU,EAAE,eAAe,QAAS,CAC3D,MAAO,OACP,KAAM,SACV,CAAI,GAIF,IAAIE,EAAW,IAAI,KAAKF,EAAQ,QAAQ,EAAE,eAAe,QAAS,CACjE,KAAM,UACN,MAAO,QACP,IAAK,SACR,CAAG,EACD,GAAIA,EAAQ,MAAQ,eAAgB,CACnC,IAAIG,EAAQ,IAAI,KAAKH,EAAQ,YAAY,EACrCI,EAAM,IAAI,KAAKJ,EAAQ,UAAU,EAEjCK,EADWF,EAAM,YAAW,IAAOC,EAAI,YAAY,EAEpDD,EAAM,eAAe,QAAS,CAAE,MAAO,QAAS,IAAK,UAAW,EAChEA,EAAM,eAAe,QAAS,CAAE,UAAW,OAAO,CAAE,EACnDG,EAAeF,EAAI,eAAe,QAAS,CAC9C,KAAM,UACN,MAAO,QACP,IAAK,SACT,CAAI,EACDF,EAAW,GAAGG,CAAc,MAAMC,CAAY,EAC/C,CAEA,MAAO,CACN,GAAIN,EAAQ,KACZ,KAAMC,EACN,OAAQ,CACP,MAAOD,EAAQ,OACf,MACCA,EAAQ,SAAW,OAChB,QACAA,EAAQ,QAAU,SAClB,SACA,MACJ,EACD,SAAUE,EACV,MAAOK,EAAeP,EAAQ,KAAK,EACnC,OAAQ,CACP,IAAKA,EAAQ,YACb,SAAU,IAAMQ,EAAgBR,EAAQ,IAAI,EAC5C,OAAQA,EAAQ,OAChB,WAAYA,EAAQ,WACpB,OAAQ,IAAMS,EAAOT,CAAO,CAC5B,CACF,CACF,GAtDwB,CAAC,CAuDzB,CAAC,EAED,SAASS,EAAOT,EAAS,CACpBA,EAAQ,mBACX,OAAO,KAAKA,EAAQ,mBAAoB,QAAQ,EAEhDL,EAAe,CACd,IAAK,+DACL,OAAQ,CACP,OAAQ,6CACR,KAAM,CAAE,KAAMK,EAAQ,IAAM,CAC5B,EACD,KAAM,GACN,UAAYU,GAAQ,OAAO,KAAKA,EAAK,QAAQ,CAChD,CAAG,CAEH,CAEA,SAASF,EAAgBR,EAAS,CACjCL,EAAe,CACd,IAAK,kFACL,KAAM,GACN,UAAYgB,GAAS,CACpB,MAAM,GAAGA,EAAK,QAAQ,sDAAuD,CAC5E,OAAQ,OACR,QAAS,CACR,eAAgB,mBAChB,sBAAuBA,EAAK,KAC5B,EACD,KAAM,KAAK,UAAU,CAAE,KAAMX,CAAO,CAAE,CAC1C,CAAI,EACC,KAAMY,GAAa,CACnB,GAAI,CAACA,EAAS,GACb,MAAM,IAAI,MAAM,+BAAiCA,EAAS,UAAU,EAErE,OAAOA,EAAS,KAAK,CAC1B,CAAK,EACA,KAAMC,GAAS,CACf,MAAMH,EAAM,OAAO,IAAI,gBAAgBG,CAAI,EAC3C,OAAO,KAAKH,EAAK,QAAQ,CAC9B,CAAK,EACA,MAAOI,GAAU,CACjB,QAAQ,MAAM,gDAAiDA,CAAK,CACzE,CAAK,CACF,CACH,CAAE,CACF,CAEA,SAASP,EAAeQ,EAAO,CAC9B,OAAIA,IAAU,EACN,GAEDC,EAAaD,CAAK,CAC1B,CAEA,SAASE,EAASF,EAAOE,EAAUC,EAAY,EAAG,CACjD,OAAO,IAAI,KAAK,aAAa,QAAS,CACrC,MAAO,WACP,SAAAD,EACA,sBAAuBC,CACzB,CAAE,EAAE,OAAOH,CAAK,CAChB,CAEA,SAASC,EAAaD,EAAOG,EAAY,EAAG,OAC3C,OAAOD,EAASF,GAAOhB,EAAAP,EAAK,OAAL,YAAAO,EAAW,SAAUmB,CAAS,CACtD"}